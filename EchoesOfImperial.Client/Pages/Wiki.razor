@page "/wiki"
@using EchoesOfImperial.Shared.DTOs
@using System.Linq
@using System.Threading
@using System.Threading.Tasks
@using System.Collections.Generic
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Wiki - Echoes of Imperial</PageTitle>

<div class="wiki-container">
    <div class="wiki-sidebar">
        <div class="sidebar-header">
            <h2>KNOWLEDGE BASE</h2>
            <p>Imperial Archives</p>
        </div>

        <nav class="wiki-nav">
            <button class='wiki-nav-item @(selectedSection == "architecture" ? "active" : "")' @onclick="SelectArchitecture">
                <span class="nav-icon">üìê</span>
                <span>Architecture</span>
            </button>
            <button class='wiki-nav-item @(selectedSection == "factions" ? "active" : "")' @onclick="SelectFactions">
                <span class="nav-icon">‚öîÔ∏è</span>
                <span>Great Factions</span>
            </button>
            <button class='wiki-nav-item @(selectedSection == "mechanics" ? "active" : "")' @onclick="SelectMechanics">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Game Mechanics</span>
            </button>
        </nav>

        <!-- Faction navigation -->
        <nav class="wiki-nav factions-list">
            @foreach (var faction in FactionsList)
            {
                <button class="wiki-nav-item faction-item @(selectedFaction == faction.Id ? "active" : "")" @onclick='@(() => SelectFaction(faction.Id))'>
                    <span class="faction-name"><strong>@faction.Name.ToUpper()</strong></span>

                    <!-- SVG-based starfield + glow for richer animation -->
                    <svg class="star-svg" viewBox="0 0 100 40" preserveAspectRatio="none" aria-hidden="true">
                        <g class="stars">
                            <circle cx="10" cy="10" r="1.2" />
                            <circle cx="28" cy="6" r="0.9" />
                            <circle cx="45" cy="14" r="1.1" />
                            <circle cx="62" cy="8" r="0.8" />
                            <circle cx="82" cy="12" r="1.3" />
                        </g>
                        <g class="glow">
                            <circle class="g1" cx="80" cy="20" r="6" />
                            <circle class="g2" cx="20" cy="22" r="4" />
                        </g>
                    </svg>
                </button>
            }
        </nav>
    </div>

    <div class="wiki-content">
        <AuthorizeView Roles="Admin">
            <Authorized>
                <div class="admin-edit-panel">
                    @if (!isEditMode)
                    {
                        <button class="btn-edit" @onclick="EnterEditMode" title="Edit this section">
                            <span class="edit-icon">‚úèÔ∏è</span>
                            EDIT
                        </button>
                    }
                    else
                    {
                        <div class="edit-controls">
                            <button class="btn-save" @onclick="SaveChanges" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-small"></span>
                                    <span>SAVING...</span>
                                }
                                else
                                {
                                    <span>üíæ SAVE CHANGES</span>
                                }
                            </button>
                            <button class="btn-cancel" @onclick="CancelEdit">‚úï CANCEL</button>
                        </div>
                    }
                </div>
            </Authorized>
        </AuthorizeView>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <div class="status-message @statusClass">@statusMessage</div>
        }

        <div class="content-panel">
            @if (!isEditMode)
            {
                @if (selectedSection == "architecture")
                {
                    @ArchitectureContent
                }
                else if (selectedSection == "factions")
                {
                    <div class="section-content">
                        <h1 class="section-title">GREAT FACTIONS</h1>
                        <hr class="imperial-divider" />

                        <div class="faction-view">
                            <div class="faction-sidebar-info">
                                <p class="section-intro">Select a faction to view detailed lore and description.</p>
                                <div class="faction-buttons-compact">
                                    @foreach (var f in FactionsList.Take(4))
                                    {
                                        <button class="mini wiki-nav-item" @onclick='@(() => SelectFaction(f.Id))'>@f.Name</button>
                                    }
                                </div>
                            </div>

                            <div class="faction-main">
                                @if (isFactionLoading)
                                {
                                    <div class="loader">Loading faction...</div>
                                }
                                else
                                {
                                    @((MarkupString)factionContent)
                                }
                            </div>
                        </div>
                    </div>
                }
                else if (selectedSection == "mechanics")
                {
                    @MechanicsContent
                }
            }
            else
            {
                <div class="edit-mode-container">
                    <div class="form-group">
                        <label>SECTION NAME</label>
                        <input type="text" @bind="editSectionName" class="form-control" readonly />
                    </div>
                    <div class="form-group">
                        <label>TITLE</label>
                        <input type="text" @bind="editTitle" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>CONTENT (HTML)</label>
                        <textarea @bind="editContent" class="form-control edit-textarea" rows="20"></textarea>
                        <p class="help-text">You can use HTML tags for formatting</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string selectedSection = "architecture";
    private bool isEditMode = false;
    private bool isSaving = false;
    private string? statusMessage;
    private string statusClass = string.Empty;

    // Edit mode fields
    private string editSectionName = string.Empty;
    private string editTitle = string.Empty;
    private string editContent = string.Empty;

    // Faction selection and data
    private string selectedFaction = "arden";
    private bool isFactionLoading = false;
    private string factionContent = string.Empty;
    private readonly Dictionary<string, string> factionCache = new();
    private CancellationTokenSource? factionDebounceCts;

    // Factions list
    private readonly List<(string Id, string Name)> FactionsList = new()
    {
        ("arden", "–ü—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞—Ç –ê—Ä–¥–µ–Ω"),
        ("nova", "–õ–∏–≥–∞ –ù–æ–≤–∞-–ö–æ—Ä–ø"),
        ("raktor", "–°–æ—é–∑ –†–∞–∫‚Äô–¢–æ—Ä"),
        ("seraphis", "–¢–µ–æ–∫—Ä–∞—Ç–∏—è –°–µ—Ä–∞—Ñ–∏—Å"),
        ("vector", "–ö–æ–Ω—Å–æ—Ä—Ü–∏—É–º –í–µ–∫—Ç–æ—Ä"),
        ("nara", "–î–æ–º–µ–Ω—ã –ù–∞—Ä–∞"),
        ("kuaru", "–ö–æ–Ω–∫–ª–∞–≤ –ö—É–∞—Ä—É"),
        ("blackbelt", "–ß–µ—Ä–Ω—ã–π –ü–æ—è—Å"),
        ("orex", "–ö–æ–Ω—Å–æ—Ä—Ü–∏—É–º OREX")
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadFactionContentAsync(selectedFaction, forceReload: false);
    }

    private void SelectFaction(string factionId)
    {
        // Cancel previous debounce if exists
        factionDebounceCts?.Cancel();
        factionDebounceCts = new CancellationTokenSource();
        var token = factionDebounceCts.Token;

        selectedFaction = factionId;
        isEditMode = false;

        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(250, token);
                await InvokeAsync(() => LoadFactionContentAsync(factionId, forceReload: false, ct: token));
            }
            catch (OperationCanceledException) { }
        });

        // Prefetch neighbors
        _ = PreloadNearbyFactionsAsync(factionId);
    }

    private async Task LoadFactionContentAsync(string factionId, bool forceReload = false, CancellationToken ct = default)
    {
        if (!forceReload && factionCache.TryGetValue(factionId, out var cached))
        {
            factionContent = cached;
            isFactionLoading = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            isFactionLoading = true;
            factionContent = string.Empty;
            await InvokeAsync(StateHasChanged);

            // Simulate network delay - replace with Http GET if endpoint exists
            await Task.Delay(200, ct);

            var content = factionId switch
            {
                "arden" => "<h2>–ü—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞—Ç –ê—Ä–¥–µ–Ω</h2><p>–ú–æ–≥—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–∞—Ç, –∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–≤–æ–µ–π —Å—Ç—Ä–æ–≥–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–µ–π...</p>",
                "nova" => "<h2>–õ–∏–≥–∞ –ù–æ–≤–∞-–ö–æ—Ä–ø</h2><p>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ª–∏–≥–∞, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–∞—è –∫—Ä—É–ø–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –ø—É—Ç–∏...</p>",
                "raktor" => "<h2>–°–æ—é–∑ –†–∞–∫‚Äô–¢–æ—Ä</h2><p>–í–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–∞–ª–∏—Ü–∏—è, –º–∞—Å—Ç–µ—Ä–∞ –±–ª–∏–∂–Ω–µ–≥–æ –±–æ—è –≤ –∫–æ—Å–º–æ—Å–µ...</p>",
                "seraphis" => "<h2>–¢–µ–æ–∫—Ä–∞—Ç–∏—è –°–µ—Ä–∞—Ñ–∏—Å</h2><p>–†–µ–ª–∏–≥–∏–æ–∑–Ω–æ–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–æ —Å —Å–∏–ª—å–Ω–æ–π –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–π —Ç—Ä–∞–¥–∏—Ü–∏–µ–π...</p>",
                "vector" => "<h2>–ö–æ–Ω—Å–æ—Ä—Ü–∏—É–º –í–µ–∫—Ç–æ—Ä</h2><p>–ù–∞—É—á–Ω–æ-—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Å–æ—Ä—Ü–∏—É–º, –ø—Ä–æ–¥–≤–∏–≥–∞—é—â–∏–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ä—ã–≤—ã...</p>",
                "nara" => "<h2>–î–æ–º–µ–Ω—ã –ù–∞—Ä–∞</h2><p>–ö–æ–Ω—Ñ–µ–¥–µ—Ä–∞—Ü–∏—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –¥–æ–º–µ–Ω–æ–≤, –∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–≤–æ–∏–º —Ñ–ª–æ—Ç–æ–º —Ä–∞–∑–≤–µ–¥–∫–∏...</p>",
                "kuaru" => "<h2>–ö–æ–Ω–∫–ª–∞–≤ –ö—É–∞—Ä—É</h2><p>–¢–∞–π–Ω—ã–π –∫–æ–Ω–∫–ª–∞–≤ –º—É–¥—Ä–µ—Ü–æ–≤ –∏ –¥–∏–ø–ª–æ–º–∞—Ç–æ–≤...</p>",
                "blackbelt" => "<h2>–ß–µ—Ä–Ω—ã–π –ü–æ—è—Å</h2><p>–†–µ–≥–∏–æ–Ω –ø–∏—Ä–∞—Ç—Å–∫–∏—Ö –∏ –º–∞—Ä–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤...</p>",
                "orex" => "<h2>–ö–æ–Ω—Å–æ—Ä—Ü–∏—É–º OREX</h2><p>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –≥–∏–≥–∞–Ω—Ç, –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π –≤ –¥–æ–±—ã—á–µ —Ä–µ—Å—É—Ä—Å–æ–≤...</p>",
                _ => "<h2>Unknown</h2><p>No data available.</p>"
            };

            factionCache[factionId] = content;
            factionContent = content;
        }
        catch (OperationCanceledException) { }
        finally
        {
            isFactionLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task PreloadNearbyFactionsAsync(string factionId)
    {
        var index = FactionsList.FindIndex(f => f.Id == factionId);
        if (index < 0) return;

        var toPreload = new List<string>();
        if (index + 1 < FactionsList.Count) toPreload.Add(FactionsList[index + 1].Id);
        if (index - 1 >= 0) toPreload.Add(FactionsList[index - 1].Id);

        foreach (var id in toPreload)
        {
            if (!factionCache.ContainsKey(id))
            {
                try { await LoadFactionContentAsync(id, forceReload: false); } catch { }
            }
        }
    }

    private void SelectArchitecture()
    {
        selectedSection = "architecture";
        ExitEditMode();
    }

    private void SelectFactions()
    {
        selectedSection = "factions";
        ExitEditMode();
    }

    private void SelectMechanics()
    {
        selectedSection = "mechanics";
        ExitEditMode();
    }

    private void EnterEditMode()
    {
        isEditMode = true;
        editSectionName = selectedSection;

        switch (selectedSection)
        {
            case "architecture": editTitle = "SYSTEM ARCHITECTURE"; editContent = GetArchitectureHtml(); break;
            case "factions": editTitle = "GREAT FACTIONS"; editContent = GetFactionsHtml(); break;
            case "mechanics": editTitle = "GAME MECHANICS"; editContent = GetMechanicsHtml(); break;
        }

        statusMessage = null;
    }

    private void CancelEdit() => ExitEditMode();
    private void ExitEditMode()
    {
        isEditMode = false;
        editSectionName = string.Empty;
        editTitle = string.Empty;
        editContent = string.Empty;
        statusMessage = null;
    }

    private async Task SaveChanges()
    {
        isSaving = true;
        statusMessage = null;
        try
        {
            var updateDto = new WikiPageUpdateDto { SectionName = editSectionName, Title = editTitle, ContentHtml = editContent };
            var pageId = GetPageIdForSection(editSectionName);
            var response = await Http.PutAsJsonAsync($"api/wiki/{pageId}", updateDto);
            if (response.IsSuccessStatusCode) { statusMessage = "‚úì Changes saved successfully!"; statusClass = "success"; ExitEditMode(); StateHasChanged(); }
            else { statusMessage = "‚úó Failed to save changes. Please try again."; statusClass = "error"; }
        }
        catch (Exception ex) { statusMessage = $"‚úó An error occurred: {ex.Message}"; statusClass = "error"; }
        finally { isSaving = false; }
    }

    private Guid GetPageIdForSection(string section) => section switch
    {
        "architecture" => new Guid("11111111-1111-1111-1111-111111111111"),
        "factions" => new Guid("22222222-2222-2222-2222-222222222222"),
        "mechanics" => new Guid("33333333-3333-3333-3333-333333333333"),
        _ => Guid.NewGuid()
    };

    private string GetArchitectureHtml() => "<h1>SYSTEM ARCHITECTURE</h1><p>The Echoes of Imperial infrastructure follows a robust multi-tier architecture...</p>";
    private string GetFactionsHtml() => "<h1>GREAT FACTIONS</h1><p>Four powerful factions vie for control of the known universe...</p>";
    private string GetMechanicsHtml() => "<h1>GAME MECHANICS</h1><p>Core gameplay systems that define the Echoes of Imperial experience.</p>";

    private RenderFragment ArchitectureContent => __builder =>
    {
        <div class="section-content">
            <h1 class="section-title">SYSTEM ARCHITECTURE</h1>
            <hr class="imperial-divider" />
            <div class="content-block">
                <h3>Hierarchy Overview</h3>
                <p>The Echoes of Imperial infrastructure follows a robust multi-tier architecture designed for scalability and real-time gameplay:</p>
            </div>
        </div>
    };

    private RenderFragment FactionsContent => __builder => { };
    private RenderFragment MechanicsContent => __builder =>
    {
        <div class="section-content">
            <h1 class="section-title">GAME MECHANICS</h1>
            <hr class="imperial-divider" />
            <p class="section-intro">Core gameplay systems that define the Echoes of Imperial experience.</p>
        </div>
    };
}
